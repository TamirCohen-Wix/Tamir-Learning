# Constraint Filter Analysis

## Where Constraint Filter is Applied

The `constraint_filter` is **automatically added by the SDL/Nile Search infrastructure** when a search is executed. It is NOT added in this codebase directly.

### Call Flow

1. **Entry Point**: `ResourcesService.searchResources()` (line 213-222)
   ```scala
   override def searchResources(
     request: SearchResourcesRequest,
   )(implicit callScope: CallScope): Future[SearchResourcesResponse] = {
     for {
       searchResult <- sdlHandler.searchResources(request.getSearch.toCursorSearch)
       ...
     } yield searchResult.toSearchResourcesResponse
   }
   ```

2. **SDL Handler**: `SdlHandler.searchResources()` (line 83-85)
   ```scala
   def searchResources(search: CursorSearch)(implicit callScope: CallScope): Future[SearchResponse[ResourceDomain]] = {
     sdl.search.search(search).execute()  // <-- Constraint filter added here by SDL framework
   }
   ```

3. **SDL Framework**: The `sdl.search.search(search).execute()` call automatically:
   - Extracts authorization context from `callScope` (implicit parameter)
   - Determines user's location access permissions
   - Generates `constraint_filter` based on user's accessible locations
   - Adds it to the search query before sending to Nile Search

### Configuration

The search is configured in `ResourcesService.apply()` (line 560):
```scala
searchOptions = SearchOptions(contextBuilder.config.appSecret),
```

This `SearchOptions` comes from `generators.modules.search.share.SearchOptions` (external module).

## The Problem: Field Path Mismatch

### Constraint Filter Uses CamelCase
The constraint_filter generated by SDL uses **camelCase** field paths:
```json
{
  "locationOptions.specificLocationOptions.businessLocations.locationId": {
    "$hasSome": ["21f75877-47c2-411a-ab69-f3d10b7b9b33"]
  },
  "locationOptions.availableInAllLocations": {
    "$eq": true
  }
}
```

### WQL Definition Uses Snake_Case
But the WQL definition in `resources_service.proto` (lines 401-405) uses **snake_case**:
```protobuf
field: "single_resource.location_options.available_in_all_locations"
field: "single_resource.location_options.specific_location_options.available_in_customer_locations"
field: "single_resource.location_options.specific_location_options.available_in_custom_locations"
field: "single_resource.location_options.specific_location_options.available_in_business_locations"
field: "single_resource.location_options.specific_location_options.business_locations.location_id"
```

## Root Cause

The constraint_filter generator in SDL/Nile Search infrastructure is using:
- **Domain/API field paths** (camelCase): `locationOptions.specificLocationOptions.businessLocations.locationId`
- But the **search index** expects WQL field paths (snake_case): `single_resource.location_options.specific_location_options.business_locations.location_id`

## Field Path Translation

The `ResourceTranslator` (line 192-206 in `ResourceProtoToDomainMappers.scala`) handles translation between API and domain, but the constraint_filter is generated **before** this translation happens, or uses a different translation path.

## Solutions to Investigate

1. **Check SDL/Nile Search Configuration**: Verify if there's a way to configure the constraint_filter generator to use snake_case paths
2. **Field Path Mapping**: Ensure the constraint_filter uses the same field path format as defined in WQL
3. **Verify Location ID**: Confirm the location ID `21f75877-47c2-411a-ab69-f3d10b7b9b33` exists and is accessible
4. **Check Authorization Context**: Verify the user's location permissions are correctly set in the authorization token

## Key Files

- `src/com/wixpress/bookings/resources/v2/handlers/SdlHandler.scala` (line 83-85) - Where search is executed
- `src/com/wixpress/bookings/resources/v2/ResourcesService.scala` (line 213-222, 560) - Service entry point and SearchOptions config
- `proto/wix/bookings/resources/v2/resources_service.proto` (lines 401-405) - WQL field definitions
- `src/com/wixpress/bookings/resources/v2/mappers/ResourceProtoToDomainMappers.scala` (line 192-206) - Field path translator

## Next Steps

1. Check if SDL framework has configuration for constraint_filter field path format
2. Verify if the constraint_filter should use `single_resource.location_options...` prefix
3. Check Nile Search logs for the exact error when constraint_filter is applied
4. Consider if the constraint_filter field paths need to be translated through `ResourceTranslator`

