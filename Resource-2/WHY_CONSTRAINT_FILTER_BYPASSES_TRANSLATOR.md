# Why constraint_filter Doesn't Go Through the Translator

## The Key Difference

### Query Endpoint (Works Correctly) ✅

**Code Flow:**
```scala
// ResourcesService.scala (line 224-228)
override def queryResources(request: QueryResourcesRequest)(...): Future[QueryResourcesResponse] = {
  sdlHandler.queryResources(request.getQuery.toCursorQuery)
}

// SdlHandler.scala (line 87-90)
def queryResources(query: CursorQuery)(...): Future[QueryResponse[ResourceDomain]] = {
  sdl.query
    .fromPlatformizedQuery(query)  // <-- KEY: Uses fromPlatformizedQuery()
    .execute()
}
```

**What Happens:**
1. `fromPlatformizedQuery()` applies the **`ContractToDomainFieldPathTranslator`** configured in SDL
2. This translator uses `AutomapperSdlFieldPathTranslator[Resource, ResourceDomain]`
3. The translator converts API field paths → Domain field paths → WQL field paths
4. **All filters in the query go through this translation**

### Search Endpoint (constraint_filter Bypasses Translation) ❌

**Code Flow:**
```scala
// ResourcesService.scala (line 213-217)
override def searchResources(request: SearchResourcesRequest)(...): Future[SearchResourcesResponse] = {
  sdlHandler.searchResources(request.getSearch.toCursorSearch)
}

// SdlHandler.scala (line 83-84)
def searchResources(search: CursorSearch)(...): Future[SearchResponse[ResourceDomain]] = {
  sdl.search.search(search).execute()  // <-- PROBLEM: Does NOT use fromPlatformizedQuery()
}
```

**What Happens:**
1. `sdl.search.search(search)` does **NOT** use `fromPlatformizedQuery()`
2. The `search` filter goes directly to Nile Search **without translation**
3. **BUT** - Nile Search infrastructure then adds `constraint_filter` **AFTER** the search call
4. The `constraint_filter` is generated using **domain field paths** (camelCase)
5. **constraint_filter bypasses the translator entirely** because:
   - It's added by Nile Search infrastructure, not your code
   - It's added AFTER `sdl.search.search()` is called
   - It uses domain field paths directly, not API paths

## Why This Design?

### Query Endpoint Design
- Uses `fromPlatformizedQuery()` which is designed to handle **API → Domain → WQL** translation
- The translator is configured at SDL setup (line 541-542):
  ```scala
  .withContractToDomainFieldPathTranslator(
    AutomapperSdlFieldPathTranslator[Resource, ResourceDomain],
  )
  ```
- This translator knows about:
  - API field paths (from proto)
  - Domain field paths (from domain classes)
  - WQL field paths (from proto WQL definitions)

### Search Endpoint Design
- Uses `sdl.search.search()` directly
- **Regular search filters** might work because they're already in the right format (or Nile Search handles them)
- **constraint_filter** is added by Nile Search infrastructure:
  - Generated automatically based on authorization context
  - Uses domain field paths (camelCase) because it reads from domain entity structure
  - **Doesn't know about WQL field paths** (snake_case) required by search index

## The Root Cause

1. **Different Translation Paths:**
   - Query: `API path` → `fromPlatformizedQuery()` → `translator` → `WQL path` ✅
   - Search filter: `API path` → `sdl.search.search()` → (no translation) → `WQL path` (might work)
   - constraint_filter: `Domain path` → (generated by Nile) → `WQL path` ❌ **FAILS**

2. **constraint_filter Generation:**
   - Generated by Nile Search infrastructure **outside your code**
   - Uses domain entity structure directly (camelCase)
   - Doesn't go through `fromPlatformizedQuery()` or any translator
   - Doesn't know about WQL field path format

3. **Missing Translation Step:**
   - constraint_filter needs: `domain path` → `WQL path`
   - But it's generated with domain paths and sent directly to Nile Search
   - No translation happens because it's not in your code path

## Why Not Use fromPlatformizedQuery for Search?

**Possible reasons:**
1. **Search uses different format** - Search might expect filters in a different format than query
2. **Performance** - Search might be optimized differently
3. **Historical reasons** - Search and Query might have been developed separately
4. **Nile Search handles it** - Regular search filters might be handled by Nile Search itself

**But constraint_filter is special:**
- It's added **by Nile Search infrastructure**, not by your code
- It's added **after** the search call
- It uses **domain paths** directly, not API paths
- It needs **WQL paths** but doesn't get translated

## The Solution

The constraint_filter needs to be translated from domain paths to WQL paths. This could be done by:

1. **Nile Search Infrastructure Fix:**
   - Make Nile Search infrastructure use WQL field paths when generating constraint_filter
   - Or make it go through the translator before adding constraint_filter

2. **Post-Processing Fix:**
   - Intercept the SearchRequest before sending to Nile Search
   - Translate constraint_filter field paths from domain → WQL
   - This would need to happen in the SDL/Nile Search integration layer

3. **Configuration Fix:**
   - Configure Nile Search to know about WQL field paths for constraint_filter
   - This might be in `SearchOptions` or SDL configuration

## Summary

**Query endpoint:** Uses `fromPlatformizedQuery()` → Goes through translator → Works ✅

**Search endpoint:** Uses `sdl.search.search()` directly → No translator → constraint_filter bypasses translation → Fails ❌

**The constraint_filter is generated by Nile Search infrastructure using domain field paths, but Nile Search expects WQL field paths. There's no translation step because constraint_filter is added outside your code path.**

